<!DOCTYPE html>
<html><head>
    <meta charset="utf-8"/>
    <title>StudyBot - Student Profile</title>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
    <style type="text/tailwindcss">
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;500;600;700&display=swap');

        * {
            font-family: 'Assistant', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: #ffffff;
        }

        .chat-container {
            background: #ffffff;
            padding-bottom: 140px;
        }

        .search-result {
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.15s ease;
        }
        .search-result:last-child {
            border-bottom: none;
        }
        .search-result:hover {
            background-color: #f3f4f6 !important;
        }

        .message-user {
            background: #4285f4;
            color: #ffffff;
            border-radius: 16px;
            max-width: 70%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
        }

        .message-bot {
            background: #f5f5f5;
            color: #000000;
            border-radius: 16px;
            max-width: 75%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .input-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            padding: 16px;
            z-index: 50;
        }

        .input-field {
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            transition: all 0.2s ease;
            background: #f9f9f9;
        }

        .input-field:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 1px #4285f4;
            background: #ffffff;
        }

        .btn-send {
            background: #4285f4;
            color: #ffffff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            transition: all 0.2s ease;
        }

        .btn-send:hover:not(:disabled) {
            background: #3367d6;
        }

        .btn-send:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .btn-send.loading {
            background: #4285f4;
            cursor: not-allowed;
        }

        .file-attachment {
            color: #4285f4;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-attachment:hover {
            color: #3367d6;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
            background: #f5f5f5;
            border-radius: 16px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-4px);
                opacity: 1;
            }
        }

        .option-button {
            background: #f5f5f5;
            color: #000000;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            padding: 8px 16px;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .option-button:hover {
            background: #4285f4;
            color: #ffffff;
            border-color: #4285f4;
        }

        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #f5f5f5;
            z-index: 60;
        }

        .progress-fill {
            height: 100%;
            background: #4285f4;
            transition: width 0.5s ease;
        }

        .avatar-bot {
            width: 36px;
            height: 36px;
            background: #f5f5f5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #4285f4;
            flex-shrink: 0;
        }

        .avatar-user {
            width: 36px;
            height: 36px;
            background: #4285f4;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #ffffff;
            flex-shrink: 0;
        }

        .message-time {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }

        .step-counter {
            position: fixed;
            top: 16px;
            right: 16px;
            background: rgba(66, 133, 244, 0.1);
            color: #4285f4;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            z-index: 55;
        }

        /* Loading spinner */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .search-dropdown {
            position: absolute;
            bottom: 100%; /* Position above the input instead of below */
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px; /* Add space between dropdown and input */
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1), 0 -2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .search-dropdown.show-below {
            bottom: auto;
            top: 100%;
            margin-bottom: 0;
            margin-top: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

    </style>
</head>
<body class="bg-white">
<!-- Progress Bar -->
<div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width: 6.67%"></div>
</div>

<!-- Step Counter -->
<div class="step-counter" id="stepCounter">
    ×©×œ×‘ 1 ××ª×•×š 18
</div>

<!-- Chat Area -->
<div class="chat-container min-h-screen" id="chatContainer">
    <div class="max-w-4xl mx-auto px-4 py-6">
        <div id="chatMessages" class="space-y-4">
            <!-- Messages will be populated here -->
        </div>
    </div>
</div>

<!-- Fixed Input Bar -->
<div class="input-bar">
    <div class="max-w-4xl mx-auto" id="inputArea">
        <!-- Dynamic input will be populated here -->
    </div>
</div>

<script>
    class StudentProfileChat {
        constructor() {
            this.currentStep = 1;
            this.totalSteps = 18;
            this.sessionId = null;
            this.apiBase = '/api/students';
            this.awaitingInput = false;
            this.isProcessing = false;
            this.improvedMessages = this.getImprovedMessages();
            this.temporaryData = {};
            this.dataConfirmed = false;
            this.profileSaved = false;
            this.resumedSession = false;
            this.init();
        }

        getImprovedMessages() {
            return {
                1: "×”×™×™! ğŸ˜ ××” ×§×•×¨×”? ×‘×•××• × ×‘× ×” ×œ×š ×¤×¨×•×¤×™×œ...",
                "2_missing": "×™×© ×œ×™ ××ª ×”×¤×¨×˜×™× ×”×‘×¡×™×¡×™×™×, ××‘×œ ×—×¡×¨ ×œ×™ {missing}...",
                "2_found": "××¦×•×™×Ÿ! ğŸ“‚ ××¦×× ×• ××ª ×”×¤×¨×˜×™× ×”××œ×”...",
                3: "××‘×¨×™×§! ×¡×¤×¨ ×œ×™ â€” ××” ××ª×” ×œ×•××“ ×‘×™××™× ××œ×”? ğŸ“",
                4: "×‘××™×–×• ×©× ×” ××ª×”? ğŸ“…",
                5: "×ª×•××¨ ×‘××”? ğŸ“š",
                6: "×•××™×¤×” ××ª×” ×œ×•××“? ğŸ«",
                7: "×™××œ×œ×” ×‘×•×× ×• × ×¨××” ××” ××ª×” ×©×•×•×” ğŸ˜‰ ××” ×”×××•×¦×¢ ×©×œ×š? (0-100) ğŸ¯",
                8: "×ª×•×“×”! ×›×“×™ ×©× ×”×™×” ×©×§×•×¤×™× ××•×œ ×”×—×‘×¨×•×ª â€” ×ª×¢×œ×” ×‘× × ××ª ×’×œ×™×•×Ÿ ×”×¦×™×•× ×™× ğŸ“Š",
                9: "×™×© ×œ×š × ×™×¡×™×•×Ÿ ×¢×‘×•×“×” ××• ×”×ª× ×“×‘×•×ª ×‘×ª×—×•×? ğŸ’¼",
                10: "×¢×©×™×ª ××©×”×• ××‘×¨×™×§ ×‘××•× ×™×‘×¨×¡×™×˜×”?...",
                11: "××™×¤×” ××ª×” ×’×¨ / ××—×¤×© ×œ×¢×‘×•×“? ğŸŒ",
                12: "×›××” ×©×¢×•×ª ×‘×©×‘×•×¢ ××ª×” ×™×›×•×œ ×œ×¢×‘×•×“? â±¥ï¸",
                13: "××ª×” ×’××™×© ×‘×©×¢×•×ª ××• ××¢×“×™×£ ×–×× ×™× ×§×‘×•×¢×™×? ğŸ¤”",
                14: "×™××œ×œ×” × ×©××¢ ××™ ××ª×”! âœ¨...",
                15: "×™×© ××©×”×• ×—×©×•×‘ ×©×ª×¨×¦×” ×©×”×—×‘×¨×•×ª ×™×“×¢×• ×¢×œ×™×š?...",
                16: "×¨×•×¦×” ×œ×”×•×¡×™×£ ×œ×™× ×§×™×?...",
                17: "××”××! ğŸ‰ ×¡×™×™×× ×• ×œ×‘× ×•×ª ××ª ×”×¤×¨×•×¤×™×œ ×©×œ×š...",
                18: "×œ×¤× ×™ ×©× ×©××•×¨ ××ª ×”×¤×¨×•×¤×™×œ, ×× ×™ ×¦×¨×™×š ×©×ª×¡×›×™× ×œ×ª× ××™ ×”×©×™××•×©..."
            };
        }


        async init() {
            try {
                // × ×¡×” ×œ××¦×•× session ×§×™×™×
                const savedSessionId = sessionStorage.getItem('studentSessionId');
                if (savedSessionId) {
                    console.log('Found saved session:', savedSessionId);
                    try {
                        await this.resumeExistingSession(savedSessionId);
                        return;
                    } catch (error) {
                        console.log('Failed to resume saved session, starting new');
                        sessionStorage.removeItem('studentSessionId');
                    }
                }

                const urlParams = new URLSearchParams(window.location.search);
                const sessionFromUrl = urlParams.get('session');

                if (sessionFromUrl) {
                    try {
                        await this.resumeExistingSession(sessionFromUrl);
                        return;
                    } catch (error) {
                        console.log('Failed to resume URL session, starting new');
                    }
                }

                await this.startSession();
                this.addMessage(this.improvedMessages[1], false, false);
                this.renderCurrentStep();
            } catch (error) {
                this.showTextInput('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×œ×©×¨×ª. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£ ×•× ×¡×” ×©×•×‘.');
            }
        }


        async resumeExistingSession(sessionId) {
            try {
                const response = await fetch(`${this.apiBase}/chat/${sessionId}/step`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    this.sessionId = sessionId;
                    this.currentStep = data.currentStep;
                    this.resumedSession = true;
                    this.updateProgress();

                    this.addMessage(`×‘×¨×•×š ×”×‘× ×‘×—×–×¨×”! ×××©×™×›×™× ××©×œ×‘ ${this.currentStep}`, false, false);

                    // Load existing data if available
                    if (data.additionalData) {
                        Object.assign(this.temporaryData, data.additionalData);
                    }

                    this.renderCurrentStep();
                    return true;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Resume session failed:', error);
                throw error;
            }
        }

        scrollToBottom(smooth = true) {
            setTimeout(() => {
                const chatContainer = document.getElementById('chatContainer');
                const scrollOptions = {
                    top: chatContainer.scrollHeight,
                    behavior: smooth ? 'smooth' : 'instant'
                };
                chatContainer.scrollTo(scrollOptions);
            }, 50);
        }

// ×¢×“×›×Ÿ startSession
        async startSession() {
            try {
                const response = await fetch(`${this.apiBase}/chat/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to start session');
                }

                this.sessionId = data.sessionId;
                this.currentStep = data.currentStep || 1;
                this.updateProgress();

                // ×©××•×¨ session ×œ×—×–×¨×” ×××•×—×¨×ª
                sessionStorage.setItem('studentSessionId', this.sessionId);

                // ×¢×“×›×Ÿ URL ×‘×œ×™ ×œ×¨×¢× ×Ÿ ×“×£
                const newUrl = `${window.location.pathname}?session=${this.sessionId}`;
                window.history.replaceState({}, '', newUrl);

                console.log('Session started:', this.sessionId);
                return data;
            } catch (error) {
                console.error('Failed to start session:', error);
                throw error;
            }
        }


        updateProgress() {
            const progressPercent = (this.currentStep / this.totalSteps) * 100;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            document.getElementById('stepCounter').textContent = `×©×œ×‘ ${this.currentStep} ××ª×•×š ${this.totalSteps}`;
        }

        addMessage(content, isUser = false, showTime = true) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');

            const timeString = showTime ? new Date().toLocaleTimeString('he-IL', {
                hour: '2-digit',
                minute: '2-digit'
            }) : '';

            if (isUser) {
                messageDiv.className = 'flex items-start gap-3 justify-end';
                messageDiv.innerHTML = `
                    <div class="flex flex-col items-end">
                        <div class="message-user px-4 py-3">
                            <p class="text-sm leading-relaxed whitespace-pre-line">${content}</p>
                        </div>
                        ${timeString ? `<div class="message-time">${timeString}</div>` : ''}
                    </div>
                    <div class="avatar-user">
                        U
                    </div>
                `;
            } else {
                messageDiv.className = 'flex items-start gap-3';
                messageDiv.innerHTML = `
                    <div class="avatar-bot">
                        S
                    </div>
                    <div class="flex flex-col">
                        <div class="message-bot px-4 py-3">
                            <p class="text-sm leading-relaxed whitespace-pre-line">${content}</p>
                        </div>
                        ${timeString ? `<div class="message-time">${timeString}</div>` : ''}
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            this.scrollToBottom();
        }

        showTyping() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator flex items-start gap-3';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="avatar-bot">
                    S
                </div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            this.scrollToBottom();
        }

        hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        setLoadingState(isLoading) {
            const sendBtn = document.getElementById('sendBtn');
            if (!sendBtn) return;

            if (isLoading) {
                sendBtn.disabled = true;
                sendBtn.classList.add('loading');
                sendBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="loading-spinner">
                        <path d="M12,4a8,8,0,0,1,7.89,6.7A1.53,1.53,0,0,0,21.38,12h0a1.5,1.5,0,0,0,1.48-1.75,11,11,0,0,0-21.72,0A1.5,1.5,0,0,0,2.62,12h0a1.53,1.53,0,0,0,1.49-1.3A8,8,0,0,1,12,4Z"/>
                    </svg>
                `;
            } else {
                sendBtn.disabled = false;
                sendBtn.classList.remove('loading');
                sendBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                `;
            }
        }

        async nextStep(userResponse = null, stepData = null) {
            if (this.isProcessing) return;
            this.isProcessing = true;

            try {
                if (userResponse && !this.awaitingInput) {
                    this.addMessage(userResponse, true);
                }

                // ×©××™×¨×” ×–×× ×™×ª ×‘×œ×‘×“ - ×œ× ×‘-DB ×¢×“ ××™×©×•×¨ ×”×ª× ××™×
                if (stepData && this.currentStep <= 17) {
                    this.temporaryData[this.currentStep] = stepData;
                }

                if (this.currentStep < 18) {
                    this.showTyping();
                    setTimeout(() => {
                        this.hideTyping();
                        this.currentStep++;
                        const message = this.improvedMessages[this.currentStep];
                        if (message) this.addMessage(message);
                        this.renderCurrentStep();
                        this.updateProgress();
                        this.isProcessing = false;
                    }, 800);
                } else {
                    // ×¨×§ ×›××Ÿ ×©××™×¨×” ×‘-DB ×œ××—×¨ ××™×©×•×¨ ×ª× ××™ ×©×™××•×©
                    this.isProcessing = false;
                }
            } catch (error) {
                this.hideTyping();
                this.isProcessing = false;
            }
        }

        // ×©××™×¨×” ×‘-DB ×¨×§ ×œ××—×¨ ××™×©×•×¨ ×ª× ××™×
// ×ª×™×§×•×Ÿ ×‘-HTML - saveAllDataToDB method
        async saveAllDataToDB() {
            try {
                console.log('Saving profile data to database...');

                // ×”×›×Ÿ × ×ª×•× ×™× ×‘×¡×™×¡×™×™×
                const basicData = {
                    name: this.parsedData?.name || '',
                    email: this.parsedData?.email || '',
                    phone: this.parsedData?.phone || ''
                };

                console.log('Basic data to save:', basicData);

                const response = await fetch(`${this.apiBase}/chat/${this.sessionId}/save-profile`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        profileData: this.temporaryData,
                        basicData: basicData, // ×”×•×¡×£ × ×ª×•× ×™× ×‘×¡×™×¡×™×™×
                        termsAccepted: true
                    })
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                this.addMessage('×”×¤×¨×•×¤×™×œ × ×©××¨ ×‘×”×¦×œ×—×”! ğŸ‰');
                this.profileSaved = true;

                const inputArea = document.getElementById('inputArea');
                inputArea.innerHTML = `
            <div class="text-center">
                <div class="inline-flex items-center gap-2 bg-green-50 text-green-700 px-4 py-2 rounded-full text-sm font-medium">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    ×”×¤×¨×•×¤×™×œ × ×©××¨ ×‘×”×¦×œ×—×”
                </div>
            </div>
        `;
            } catch (error) {
                console.error('Failed to save profile:', error);
                this.addMessage('×©×’×™××” ×‘×©××™×¨×ª ×”×¤×¨×•×¤×™×œ. ×× × × ×¡×” ×©×•×‘.');
            }
        }


        renderCurrentStep(stepConfig = null) {
            if (!stepConfig) {
                stepConfig = this.getDefaultStepConfig();
            }
            this.renderInput(stepConfig);
        }

        getDefaultStepConfig() {
            const steps = {
                1: {type: "file_upload", buttonText: "×”×¢×œ×” ×§×•×‘×¥ CV ğŸ“„", accept: ".pdf,.doc,.docx"},
                2: {type: "verification"},
                3: {
                    type: "buttons",
                    options: [
                        {value: "bachelor", label: "ğŸ“ ×ª×•××¨ ×¨××©×•×Ÿ"},
                        {value: "master", label: "ğŸ“ ×ª×•××¨ ×©× ×™"},
                        {value: "certificate", label: "ğŸ“œ ×ª×¢×•×“×”"},
                        {value: "professional_course", label: "ğŸ“š ×§×•×¨×¡ ××§×¦×•×¢×™"},
                        {value: "other", label: "ğŸ§  ××—×¨"}
                    ]
                },
                4: {
                    type: "slider",
                    min: 0,
                    max: 7,
                    labels: ["×˜×¨×•× ××§×“××™×”", "×©× ×” ×'", "×©× ×” ×‘'", "×©× ×” ×’'", "×©× ×” ×“'", "×©× ×” ×”'", "×©× ×” ×•'", "×‘×•×’×¨"],
                    placeholder: "×‘×—×¨ ×©× ×ª ×œ×™××•×“×™×"
                },
                5: {
                    type: "search_select",
                    placeholder: "×—×¤×© ×ª×—×•× ×œ×™××•×“×™×...",
                    options: "degrees"
                },
                6: {
                    type: "search_select",
                    placeholder: "×—×¤×© ××•×¡×“ ×œ×™××•×“×™×...",
                    options: "institutions"
                },
                7: {type: "number", placeholder: "×”×›× ×¡ ×××•×¦×¢ (0-100)", min: 0, max: 100},
                8: {type: "file_upload", buttonText: "×”×¢×œ×” ×’×œ×™×•×Ÿ ×¦×™×•× ×™× ğŸ“Š", accept: ".pdf,.jpg,.jpeg,.png"},
                9: {
                    type: "yes_no",
                    options: [
                        {value: "yes", label: "ğŸ‘ ×›×Ÿ", followUp: "textarea"},
                        {value: "no", label: "ğŸ‘ ×œ×"}
                    ]
                },
                10: {type: "textarea", placeholder: "×¡×¤×¨ ×¢×œ ×ª×¤×§×™×“×™× ××™×•×—×“×™× ××• ×”×™×©×’×™×..."},
                11: {type: "text", placeholder: "×œ××©×œ: ×ª×œ ××‘×™×‘ / ××–×•×¨ ×”×©×¨×•×Ÿ"},
                12: {
                    type: "buttons",
                    options: [
                        {value: "full_time", label: "ğŸ’¼ ××©×¨×” ××œ××”"},
                        {value: "part_time", label: "â³ ×—×¦×™ ××©×¨×”"},
                        {value: "flexible", label: "ğŸŒ€ ×’××™×©"},
                        {value: "other", label: "ğŸ“ ××—×¨"}
                    ]
                },
                13: {
                    type: "yes_no",
                    options: [
                        {value: "yes", label: "ğŸ‘ ×›×Ÿ", followUp: "text"},
                        {value: "no", label: "ğŸ‘ ×œ×"}
                    ]
                },
                14: {type: "textarea", placeholder: "×›×ª×•×‘ ×›××” ××©×¤×˜×™× ×¢×œ ×¢×¦××š..."},
                15: {type: "textarea", placeholder: "××™×“×¢ × ×•×¡×£ ×©×—×©×•×‘ ×œ×š ×œ×©×ª×£..."},
                16: {type: "links"},
                17: {type: "summary"},
                18: {type: "terms"}
            };

            return steps[this.currentStep] || {type: "text", placeholder: "×”×›× ×¡ ×ª×©×•×‘×”"};
        }

        getDegreesList() {
            return [
                "××“×¢×™ ×”××—×©×‘", "×”× ×“×¡×ª ×ª×•×›× ×”", "×”× ×“×¡×ª ××—×©×‘×™×", "×”× ×“×¡×” ×—×©××œ×™×ª",
                "×”× ×“×¡×” ××›× ×™×ª", "×”× ×“×¡×” ×›×™××™×ª", "×”× ×“×¡×” ×ª×¢×©×™×™×ª×™ ×•× ×™×“×•×œ", "×”× ×“×¡×” ××–×¨×—×™×ª",
                "×›×œ×›×œ×”", "×× ×”×œ ×¢×¡×§×™×", "×—×©×‘×•× ××•×ª", "××™××•×Ÿ", "×©×™×•×•×§", "×›×œ×›×œ×” ×•×—×©×‘×•× ××•×ª",
                "××©×¤×˜×™×", "×¤×¡×™×›×•×œ×•×’×™×”", "×¡×•×¦×™×•×œ×•×’×™×”", "××“×¢×™ ×”××“×™× ×”", "×™×—×¡×™× ×‘×™× ×œ××•××™×™×",
                "×ª×§×©×•×¨×ª", "×¢×™×ª×•× ××•×ª", "×™×—×¡×™ ×¦×‘×•×™", "×¤×¨×¡×•×", "×¨×¤×•××”", "×¡×™×¢×•×“", "×¨×•×§×—×•×ª",
                "×‘×™×•×œ×•×’×™×”", "×›×™××™×”", "×¤×™×–×™×§×”", "××ª××˜×™×§×”", "×¡×˜×˜×™×¡×˜×™×§×”", "×’×™××•×’×¨×¤×™×”",
                "×”×™×¡×˜×•×¨×™×”", "×¤×™×œ×•×¡×•×¤×™×”", "×¡×¤×¨×•×ª ×¢×‘×¨×™×ª", "×¡×¤×¨×•×ª ×× ×’×œ×™×ª", "×‘×œ×©× ×•×ª",
                "×—×™× ×•×š", "×¢×‘×•×“×” ×¡×•×¦×™××œ×™×ª", "××× ×•×™×•×ª", "××•×–×™×§×”", "×ª×™××˜×¨×•×Ÿ", "×§×•×œ× ×•×¢"
            ];
        }

        getInstitutionsList() {
            return [
                "××•× ×™×‘×¨×¡×™×˜×ª ×ª×œ ××‘×™×‘", "×”××•× ×™×‘×¨×¡×™×˜×” ×”×¢×‘×¨×™×ª ×‘×™×¨×•×©×œ×™×", "×˜×›× ×™×•×Ÿ - ××›×•×Ÿ ×˜×›× ×•×œ×•×’×™ ×œ×™×©×¨××œ",
                "××•× ×™×‘×¨×¡×™×˜×ª ×‘×Ÿ ×’×•×¨×™×•×Ÿ ×‘× ×’×‘", "××•× ×™×‘×¨×¡×™×˜×ª ×‘×¨ ××™×œ×Ÿ", "××•× ×™×‘×¨×¡×™×˜×ª ×—×™×¤×”",
                "××•× ×™×‘×¨×¡×™×˜×ª ××¨×™××œ ×‘×©×•××¨×•×Ÿ", "×”×§×¨×™×” ×”××§×“××™×ª ××•× ×•", "××›×œ×œ×ª ×ª×œ ××‘×™×‘ ×™×¤×•",
                "×”××›×œ×œ×” ×”××§×“××™×ª × ×ª× ×™×”", "×”××›×œ×œ×” ×”××§×“××™×ª ×›× ×¨×ª", "××›×œ×œ×ª ×¡×¤×™×¨",
                "×”××›×•×Ÿ ×”×˜×›× ×•×œ×•×’×™ ×—×•×œ×•×Ÿ", "××›×œ×œ×ª ×©× ×§×¨", "××›×œ×œ×ª ×¨×•×¤×™×Ÿ", "××›×œ×œ×ª ××©×§×œ×•×Ÿ",
                "×”××›×œ×œ×” ×œ×× ×”×œ", "××›×œ×œ×ª ×”×“×¡×™×", "××›×œ×œ×ª ×œ×•×™×¡×§×™", "×”××¨×›×– ×”××§×“××™ ×œ×‘",
                "×”××›×œ×œ×” ×”××§×“××™×ª ×‘×™×ª ×‘×¨×œ", "××›×œ×œ×ª ×¡××™ ×©××¢×•×Ÿ", "×”××›×œ×œ×” ×”××§×“××™×ª ×¢××§ ×™×–×¨×¢××œ",
                "××›×œ×œ×ª ×‘×¨×•×š", "××›×œ×œ×ª ××¤×§×”", "×‘×¦×œ××œ - ××§×“××™×” ×œ××× ×•×ª ×•×¢×™×¦×•×‘"
            ];
        }

        renderSearchSelect(stepConfig) {
            const inputArea = document.getElementById('inputArea');

            const lists = {
                degrees: this.getDegreesList(),
                institutions: this.getInstitutionsList()
            };

            const options = lists[stepConfig.options] || [];
            const fuse = new Fuse(options, {
                threshold: 0.3,
                includeScore: true,
                keys: [{name: 'item', weight: 1}]
            });

            inputArea.innerHTML = `
        <div class="flex items-center gap-3">
            <div class="flex-1 relative">
                <input type="text" class="input-field w-full px-4 py-3"
                       placeholder="${stepConfig.placeholder}" id="searchInput" autocomplete="off">
                <div id="searchResults" class="search-dropdown hidden"></div>
            </div>
            <button class="btn-send flex items-center justify-center" id="sendBtn" disabled>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    `;

            const input = document.getElementById('searchInput');
            const results = document.getElementById('searchResults');
            const sendBtn = document.getElementById('sendBtn');
            let selectedValue = '';
            let validSelection = false;

            // Check if there's enough space above for dropdown
            const checkDropdownPosition = () => {
                const inputRect = input.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const spaceAbove = inputRect.top;
                const spaceBelow = viewportHeight - inputRect.bottom;

                if (spaceAbove > 250 || spaceAbove > spaceBelow) {
                    results.classList.remove('show-below');
                } else {
                    results.classList.add('show-below');
                }
            };

            const showAllOptions = () => {
                checkDropdownPosition();
                results.innerHTML = options.slice(0, 8).map(option =>
                    `<div class="search-result px-4 py-2 hover:bg-gray-100 cursor-pointer border-b last:border-b-0">${option}</div>`
                ).join('');
                results.classList.remove('hidden');
                attachClickHandlers();
            };

            const attachClickHandlers = () => {
                results.querySelectorAll('.search-result').forEach(item => {
                    item.addEventListener('click', () => {
                        selectedValue = item.textContent;
                        validSelection = true;
                        input.value = selectedValue;
                        results.classList.add('hidden');
                        sendBtn.disabled = false;
                    });
                });
            };

            input.addEventListener('focus', () => {
                setTimeout(showAllOptions, 100); // Delay to ensure proper positioning
            });

            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                validSelection = false;
                sendBtn.disabled = true;

                if (query.length === 0) {
                    showAllOptions();
                    return;
                }

                if (query.length < 2) {
                    results.classList.add('hidden');
                    return;
                }

                checkDropdownPosition();
                const searchResults = fuse.search(query).slice(0, 6);
                if (searchResults.length === 0) {
                    results.innerHTML = '<div class="px-4 py-2 text-gray-500">×œ× × ××¦××• ×ª×•×¦××•×ª</div>';
                    results.classList.remove('hidden');
                    return;
                }

                results.innerHTML = searchResults.map(result =>
                    `<div class="search-result px-4 py-2 hover:bg-gray-100 cursor-pointer border-b last:border-b-0">${result.item}</div>`
                ).join('');

                results.classList.remove('hidden');
                attachClickHandlers();

                // Check if input exactly matches an option
                const exactMatch = options.find(option =>
                    option.toLowerCase() === query.toLowerCase()
                );
                if (exactMatch) {
                    selectedValue = exactMatch;
                    validSelection = true;
                    sendBtn.disabled = false;
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !results.contains(e.target)) {
                    results.classList.add('hidden');
                }
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (!results.classList.contains('hidden')) {
                    checkDropdownPosition();
                }
            });

            sendBtn.addEventListener('click', () => {
                if (!validSelection && !options.includes(selectedValue)) {
                    this.addMessage('×× × ×‘×—×¨ ××¤×©×¨×•×ª ××”×¨×©×™××” ××• ×”×§×œ×“ ×‘×“×™×•×§ ×›×¤×™ ×©××•×¤×™×¢ ×‘×¨×©×™××”', false);
                    return;
                }

                const value = selectedValue || input.value.trim();
                if (value) {
                    const stepData = {response: value};
                    this.temporaryData[this.currentStep] = stepData;
                    this.nextStep(value, stepData);
                }
            });

            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    if (!validSelection && !options.includes(selectedValue)) {
                        this.addMessage('×× × ×‘×—×¨ ××¤×©×¨×•×ª ××”×¨×©×™××” ××• ×”×§×œ×“ ×‘×“×™×•×§ ×›×¤×™ ×©××•×¤×™×¢ ×‘×¨×©×™××”', false);
                        return;
                    }

                    const value = selectedValue || input.value.trim();
                    if (value) {
                        const stepData = {response: value};
                        this.temporaryData[this.currentStep] = stepData;
                        this.nextStep(value, stepData);
                    }
                }
            });
        }

        renderInput(stepConfig) {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = '';

            switch (stepConfig.type) {
                case 'file_upload':
                    this.renderFileUpload(stepConfig);
                    break;
                case 'verification':
                    this.renderVerification(stepConfig);
                    break;
                case 'buttons':
                    this.renderButtons(stepConfig);
                    break;
                case 'search_select':
                    this.renderSearchSelect(stepConfig);
                    break;
                case 'slider':
                    this.renderSlider(stepConfig);
                    break;
                case 'text':
                case 'number':
                    this.renderTextInput(stepConfig);
                    break;
                case 'yes_no':
                    this.renderButtons(stepConfig);
                    break;
                case 'textarea':
                    this.renderTextInput(stepConfig, true);
                    break;
                case 'links':
                    this.renderLinks(stepConfig);
                    break;
                case 'summary':
                    this.renderSummary(stepConfig);
                    break;
                case 'terms':
                    this.renderTerms(stepConfig);
                    break;
                default:
                    this.showTextInput('×©×œ×‘ ×œ× ××•×›×¨');
            }
        }

        renderSlider(stepConfig) {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = `
        <div class="space-y-4">
            <div class="text-center text-sm text-gray-600" id="sliderValue">
                ${stepConfig.labels[0]}
            </div>
            <div class="px-4">
                <input type="range" min="${stepConfig.min}" max="${stepConfig.max}"
                       value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                       id="yearSlider">
            </div>
            <div class="flex justify-center">
                <button class="btn-send flex items-center justify-center" id="sendBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    `;

            const slider = document.getElementById('yearSlider');
            const valueDisplay = document.getElementById('sliderValue');
            const sendBtn = document.getElementById('sendBtn');

            slider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                valueDisplay.textContent = stepConfig.labels[value];
            });

            sendBtn.addEventListener('click', () => {
                if (this.isProcessing) return;
                const value = parseInt(slider.value);
                const label = stepConfig.labels[value];
                const stepData = { response: value.toString() };
                this.nextStep(label, stepData);
            });
        }

        renderTerms() {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = `
                <div class="flex flex-wrap gap-2 justify-center">
                    <button class="option-button" id="agreeBtn">×× ×™ ××¡×›×™× ×œ×ª× ××™ ×”×©×™××•×©</button>
                    <button class="option-button" id="disagreeBtn">×œ× ××¡×›×™×</button>
                </div>
                <div class="text-center mt-2">
                    <a href="/terms" target="_blank" class="text-xs text-blue-500 hover:underline">×§×¨× ×ª× ××™ ×©×™××•×©</a>
                    <span class="text-xs text-gray-500 mx-2">|</span>
                    <a href="/privacy" target="_blank" class="text-xs text-blue-500 hover:underline">××“×™× ×™×•×ª ×¤×¨×˜×™×•×ª</a>
                </div>
            `;

            document.getElementById('agreeBtn').addEventListener('click', () => {
                if (this.isProcessing) return;
                this.addMessage('×× ×™ ××¡×›×™× ×œ×ª× ××™ ×”×©×™××•×©', true);
                this.dataConfirmed = true;
                this.temporaryData[18] = {response: 'agreed'};
                this.saveAllDataToDB(); // ×¨×§ ×›××Ÿ × ×©××¨ ×‘-DB
            });

            document.getElementById('disagreeBtn').addEventListener('click', () => {
                this.addMessage('×œ× ××¡×›×™×', true);
                this.addMessage('×œ×¦×¢×¨× ×•, ×œ× × ×™×ª×Ÿ ×œ×”××©×™×š ×œ×œ× ×”×¡×›××” ×œ×ª× ××™ ×”×©×™××•×©.');
                const inputArea = document.getElementById('inputArea');
                inputArea.innerHTML = '<div class="text-center text-gray-500">×ª×•×“×” ×¢×œ ×”×–××Ÿ!</div>';
            });
        }

        renderFileUpload(stepConfig) {
            const inputArea = document.getElementById('inputArea');
            const uploadType = this.currentStep === 1 ? 'cv' : 'transcript';

            inputArea.innerHTML = `
                <div class="flex items-center gap-3">
                    <input type="file" id="fileInput" class="hidden" accept="${stepConfig.accept}">
                    <button class="file-attachment p-2 hover:bg-gray-50 rounded-full" id="attachBtn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                    </button>
                    <div class="flex-1">
                        <input type="text" class="input-field w-full px-4 py-3 pr-12" placeholder="${stepConfig.buttonText}" readonly id="fileDisplay">
                    </div>
                    <button class="btn-send flex items-center justify-center" id="sendBtn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            `;

            const attachBtn = document.getElementById('attachBtn');
            const fileInput = document.getElementById('fileInput');
            const fileDisplay = document.getElementById('fileDisplay');
            const sendBtn = document.getElementById('sendBtn');

            attachBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    fileDisplay.value = file.name;
                    sendBtn.disabled = false;
                    sendBtn.addEventListener('click', () => this.handleFileUpload(file, uploadType), {once: true});
                }
            });
        }

        async renderVerification() {
            try {
                let extractedData;

                if (this.existingUserData) {
                    const improvedMessage = `× ××¦× ×¤×¨×•×¤×™×œ ×§×™×™× ×¢×‘×•×¨ **${this.existingUserData.name}**\n\n×”×× ×‘×¨×¦×•× ×š ×œ×¢×“×›×Ÿ ××ª ×”×¤×¨×•×¤×™×œ ×”×§×™×™× ××• ×œ×™×¦×•×¨ ×—×“×©?`;
                    this.addMessage(improvedMessage);

                    this.renderButtons({
                        type: "buttons",
                        options: [
                            {value: "replace", label: "âœï¸ ×¢×“×›×Ÿ ×¤×¨×•×¤×™×œ ×§×™×™×"},
                            {value: "new", label: "â• ×¦×•×¨ ×¤×¨×•×¤×™×œ ×—×“×©"}
                        ]
                    });
                    return;
                }

                if (this.parsedData) {
                    extractedData = this.parsedData;
                } else {
                    // × ×ª×•× ×™× ××“×•××™× ×œ×¦×•×¨×š ×”×“×’××”
                    extractedData = {
                        name: '×œ× ×–×•×”×”',
                        email: '×œ× ×–×•×”×”',
                        phone: '×œ× ×–×•×”×”'
                    };
                }

                const missingFields = [];
                if (!extractedData.name || extractedData.name === '×œ× ×–×•×”×”') missingFields.push('×©× ××œ×');
                if (!extractedData.email || extractedData.email === '×œ× ×–×•×”×”') missingFields.push('××™××™×™×œ');
                if (!extractedData.phone || extractedData.phone === '×œ× ×–×•×”×”') missingFields.push('×˜×œ×¤×•×Ÿ');

                if (missingFields.length > 0) {
                    const message = this.improvedMessages['2_missing']
                        .replace('{missing}', missingFields.join(', '))
                        .replace('{first}', missingFields[0]);

                    this.addMessage(message);
                    this.awaitingMissingData = {missing: missingFields, current: 0, data: extractedData};
                    this.renderTextInput({type: 'text', placeholder: `×”×›× ×¡ ${missingFields[0]}`});
                } else {
                    const dataText = [
                        extractedData.name ? `**×©×:** ${extractedData.name}` : null,
                        extractedData.email ? `**××™××™×™×œ:** ${extractedData.email}` : null,
                        extractedData.phone ? `**×˜×œ×¤×•×Ÿ:** ${extractedData.phone}` : null
                    ].filter(Boolean).join('\n');

                    if (dataText) {
                        const verificationMessage = this.improvedMessages['2_found'].replace('{data}', dataText);
                        this.addMessage(verificationMessage);
                    }

                    setTimeout(() => {
                        this.renderButtons({
                            type: "buttons",
                            options: [
                                {value: "correct", label: "âœ… × ×›×•×Ÿ"},
                                {value: "incorrect", label: "âœï¸ ×¦×¨×™×š ×œ×ª×§×Ÿ"}
                            ]
                        });
                    }, 300);
                }

            } catch (error) {
                this.addMessage('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×§×•×‘×¥');
                console.error('Verification render error:', error);
            }
        }


        async handleExistingUserReplace() {
            this.addMessage('×¢×“×›×Ÿ ×¤×¨×•×¤×™×œ ×§×™×™×', true);
            this.addMessage('×”×¤×¨×•×¤×™×œ ×”×§×™×™× ×™×¢×•×“×›×Ÿ ×¢× ×”××™×“×¢ ×”×—×“×©');
            this.existingUserData = null;
            this.currentStep = 3;
            this.updateProgress();
            setTimeout(() => {
                this.addMessage(this.improvedMessages[3]);
                this.renderCurrentStep();
            }, 500);
        }

        async handleExistingUserNew() {
            this.addMessage('×¦×•×¨ ×¤×¨×•×¤×™×œ ×—×“×©', true);
            this.addMessage('×××©×™×›×™× ×¢× ×¤×¨×•×¤×™×œ ×—×“×©');
            this.existingUserData = null;
            this.currentStep = 2;
            this.updateProgress();
            setTimeout(() => this.renderVerification(), 500);
        }

        renderButtons(stepConfig) {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = `
        <div class="flex flex-wrap gap-2 justify-center">
            ${stepConfig.options.map(option => `
                <button class="option-button option-btn" data-value="${option.value}" data-label="${option.label}">
                    ${option.label}
                </button>
            `).join('')}
        </div>
    `;

            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (this.isProcessing) return;

                    const option = stepConfig.options.find(opt => opt.value === e.target.dataset.value);

                    // Handle verification step corrections
                    if (this.currentStep === 2) {
                        if (e.target.dataset.value === 'correct') {
                            this.addMessage('× ×›×•×Ÿ âœ…', true);
                            this.nextStep();
                        } else if (e.target.dataset.value === 'incorrect') {
                            this.addMessage('×¦×¨×™×š ×œ×ª×§×Ÿ', true);
                            this.addMessage('××™×–×” ×¤×¨×˜ ×ª×¨×¦×” ×œ×ª×§×Ÿ?');
                            this.renderButtons({
                                type: "buttons",
                                options: [
                                    {value: "fix_name", label: "ğŸ“ ×ª×§×Ÿ ×©×"},
                                    {value: "fix_email", label: "ğŸ“§ ×ª×§×Ÿ ××™××™×™×œ"},
                                    {value: "fix_phone", label: "ğŸ“± ×ª×§×Ÿ ×˜×œ×¤×•×Ÿ"},
                                    {value: "fix_all", label: "ğŸ”„ ×ª×§×Ÿ ×”×›×œ"}
                                ]
                            });
                            this.correctionMode = true;
                            return;
                        }
                    }

                    // Handle correction mode
                    if (this.correctionMode) {
                        this.addMessage(e.target.dataset.label, true);

                        if (e.target.dataset.value === 'fix_name') {
                            this.addMessage('×”×›× ×¡ ××ª ×”×©× ×”× ×›×•×Ÿ:');
                            this.renderTextInput({type: 'text', placeholder: '×”×›× ×¡ ×©× ××œ×'});
                            this.fixingField = 'name';
                        } else if (e.target.dataset.value === 'fix_email') {
                            this.addMessage('×”×›× ×¡ ××ª ×”××™××™×™×œ ×”× ×›×•×Ÿ:');
                            this.renderTextInput({type: 'email', placeholder: '×”×›× ×¡ ××™××™×™×œ'});
                            this.fixingField = 'email';
                        } else if (e.target.dataset.value === 'fix_phone') {
                            this.addMessage('×”×›× ×¡ ××ª ×”×˜×œ×¤×•×Ÿ ×”× ×›×•×Ÿ:');
                            this.renderTextInput({type: 'tel', placeholder: '×”×›× ×¡ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ'});
                            this.fixingField = 'phone';
                        } else if (e.target.dataset.value === 'fix_all') {
                            this.addMessage('×‘×•×× ×• × ×ª×§×Ÿ ×”×›×œ. ×ª×ª×—×™×œ ×¢× ×”×©×:');
                            this.renderTextInput({type: 'text', placeholder: '×”×›× ×¡ ×©× ××œ×'});
                            this.fixingField = 'name';
                            this.fixingAll = true;
                            this.fixingQueue = ['email', 'phone'];
                        }
                        return;
                    }

                    // Handle other button types (existing logic)
                    if (e.target.dataset.value === 'replace' && this.existingUserData) {
                        this.handleExistingUserReplace();
                    } else if (e.target.dataset.value === 'new' && this.existingUserData) {
                        this.handleExistingUserNew();
                    } else if (option && option.followUp) {
                        this.addMessage(e.target.dataset.label, true);
                        this.addMessage(`× ×”×“×¨! ×¢×›×©×™×• ${option.followUp === 'textarea' ? '×¡×¤×¨ ×œ×™ ×™×•×ª×¨ ×¢×œ ×–×”:' : '×ª×Ÿ ×œ×™ ×¤×¨×˜×™× × ×•×¡×¤×™×:'}`);
                        this.renderTextInput({
                            type: option.followUp,
                            placeholder: option.followUp === 'textarea' ? '×ª××¨ ××ª ×”× ×™×¡×™×•×Ÿ ×©×œ×š...' : '×¤×¨×˜ ×¢×œ ×”×’××™×©×•×ª ×©×œ×š...'
                        }, option.followUp === 'textarea');
                        this.pendingYesNo = {value: e.target.dataset.value, label: e.target.dataset.label};
                    } else {
                        const stepData = {response: e.target.dataset.value};
                        this.nextStep(e.target.dataset.label, stepData);
                    }
                });
            });
        }


        renderTextInput(stepConfig, isTextarea = false) {
            const inputArea = document.getElementById('inputArea');
            const inputType = isTextarea ? 'textarea' : (stepConfig.type === 'number' ? 'number' : 'text');

            inputArea.innerHTML = `
        <div class="flex items-${isTextarea ? 'end' : 'center'} gap-3">
            <div class="flex-1">
                <${isTextarea ? 'textarea' : 'input'}
                    type="${inputType}"
                    class="input-field w-full px-4 py-3 pr-12 ${isTextarea ? 'min-h-[80px] resize-none' : ''}"
                    placeholder="${stepConfig.placeholder || '×”×›× ×¡ ×ª×©×•×‘×”'}"
                    id="textInput"
                    ${stepConfig.min !== undefined ? `min="${stepConfig.min}"` : ''}
                    ${stepConfig.max !== undefined ? `max="${stepConfig.max}"` : ''}
                ></${isTextarea ? 'textarea' : 'input'}>
            </div>
            <button class="btn-send flex items-center justify-center" id="sendBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    `;

            const input = document.getElementById('textInput');
            const sendBtn = document.getElementById('sendBtn');

            input.focus();

            const submitHandler = () => {
                if (this.isProcessing) return;

                let value = input.value.trim();

                // Validation for number inputs (GPA)
                if (stepConfig.type === 'number') {
                    const numValue = parseFloat(value);
                    if (isNaN(numValue) || numValue < (stepConfig.min || 0) || numValue > (stepConfig.max || 100)) {
                        this.addMessage(`×× × ×”×›× ×¡ ××¡×¤×¨ ×‘×™×Ÿ ${stepConfig.min || 0} ×œ-${stepConfig.max || 100}`, false);
                        return;
                    }
                    value = numValue.toString();
                }

                if (!value && stepConfig.type !== 'textarea') {
                    this.addMessage('×× × ×”×›× ×¡ ×ª×©×•×‘×”');
                    return;
                }

                this.setLoadingState(true);

                // Handle correction mode
                if (this.correctionMode && this.fixingField) {
                    this.addMessage(value, true);

                    // Update the parsed data
                    if (!this.parsedData) this.parsedData = {};
                    this.parsedData[this.fixingField] = value;

                    if (this.fixingAll && this.fixingQueue.length > 0) {
                        // Continue fixing next field
                        const nextField = this.fixingQueue.shift();
                        this.fixingField = nextField;

                        const fieldName = nextField === 'email' ? '××™××™×™×œ' : '×˜×œ×¤×•×Ÿ';
                        const placeholder = nextField === 'email' ? '×”×›× ×¡ ××™××™×™×œ' : '×”×›× ×¡ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ';

                        this.addMessage(`×¢×›×©×™×• ×”×›× ×¡ ××ª ×”${fieldName}:`);
                        this.renderTextInput({type: nextField === 'email' ? 'email' : 'tel', placeholder});
                    } else {
                        // Done fixing - show updated data
                        this.correctionMode = false;
                        this.fixingField = null;
                        this.fixingAll = false;
                        this.fixingQueue = [];

                        const dataText = [
                            this.parsedData.name ? `**×©×:** ${this.parsedData.name}` : null,
                            this.parsedData.email ? `**××™××™×™×œ:** ${this.parsedData.email}` : null,
                            this.parsedData.phone ? `**×˜×œ×¤×•×Ÿ:** ${this.parsedData.phone}` : null
                        ].filter(Boolean).join('\n');

                        this.addMessage(`××¢×•×œ×”! ×¢×›×©×™×• ×”× ×ª×•× ×™× ×”××¢×•×“×›× ×™×:\n\n${dataText}\n\n×”×›×œ × ×›×•×Ÿ?`);

                        this.renderButtons({
                            type: "buttons",
                            options: [
                                {value: "correct", label: "âœ… × ×›×•×Ÿ"},
                                {value: "incorrect", label: "âœï¸ ×¦×¨×™×š ×œ×ª×§×Ÿ ×¢×•×“"}
                            ]
                        });
                    }
                    this.setLoadingState(false);
                    return;
                }

                // Handle missing data input
                if (this.awaitingMissingData) {
                    this.handleMissingDataInput(value);
                } else if (this.pendingYesNo) {
                    const stepData = {
                        response: this.pendingYesNo.value,
                        additionalData: value ? {description: value, details: value} : null
                    };
                    this.nextStep(`${this.pendingYesNo.label}${value ? ': ' + value : ''}`, stepData);
                    this.pendingYesNo = null;
                } else {
                    const stepData = {response: value || '×“×™×œ×’×ª×™ ×¢×œ ×”×©××œ×”'};
                    this.nextStep(value || '×“×™×œ×’×ª×™ ×¢×œ ×”×©××œ×”', stepData);
                }
            };

            sendBtn.addEventListener('click', submitHandler);

            if (!isTextarea) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitHandler();
                    }
                });
            } else {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        submitHandler();
                    }
                });
            }
        }

        handleMissingDataInput(value) {
            const missingData = this.awaitingMissingData;
            const fieldName = missingData.missing[missingData.current];

            if (fieldName === '×©× ××œ×') missingData.data.name = value;
            else if (fieldName === '××™××™×™×œ') missingData.data.email = value;
            else if (fieldName === '×˜×œ×¤×•×Ÿ') missingData.data.phone = value;

            this.addMessage(value, true);

            missingData.current++;

            if (missingData.current < missingData.missing.length) {
                const nextField = missingData.missing[missingData.current];
                this.addMessage(`×ª×•×“×”! ×¢×›×©×™×• ×”×›× ×¡ ××ª ${nextField}:`);
                this.renderTextInput({type: 'text', placeholder: `×”×›× ×¡ ${nextField}`});
            } else {
                const completeMessage = `××¢×•×œ×”! ×¢×›×©×™×• ×™×© ×œ×™ ××ª ×›×œ ×”×¤×¨×˜×™×:\n\n**×©×:** ${missingData.data.name}\n**××™××™×™×œ:** ${missingData.data.email}\n**×˜×œ×¤×•×Ÿ:** ${missingData.data.phone}\n\n×”×¤×¨×˜×™× × ×›×•× ×™×?`;
                this.addMessage(completeMessage);
                this.awaitingMissingData = null;
                this.renderButtons({
                    type: "buttons",
                    options: [
                        {value: "correct", label: "× ×›×•×Ÿ âœ…"},
                        {value: "incorrect", label: "×¦×¨×™×š ×œ×ª×§×Ÿ"}
                    ]
                });
                this.parsedData = missingData.data;
            }
            this.setLoadingState(false);
        }

        renderLinks() {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = `
                <div class="flex flex-wrap gap-2 justify-center">
                    <button class="option-button" id="noLinksBtn">××™×Ÿ ×›×¨×’×¢</button>
                    <button class="option-button" id="addLinksBtn">×”×•×¡×£ ×§×™×©×•×¨×™×</button>
                </div>
            `;

            document.getElementById('noLinksBtn').addEventListener('click', () => {
                if (this.isProcessing) return;
                const stepData = {response: 'none'};
                this.nextStep('××™×Ÿ ×œ×™× ×§×™× ×›×¨×’×¢', stepData);
            });

            document.getElementById('addLinksBtn').addEventListener('click', () => {
                if (this.isProcessing) return;
                this.addMessage('×”×•×¡×£ ×§×™×©×•×¨×™×', true);
                this.addMessage('××™×–×” ×§×™×©×•×¨×™× ×ª×¨×¦×” ×œ×”×•×¡×™×£?');
                this.showLinksInput();
            });
        }

        showLinksInput() {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <input type="url" class="input-field w-full px-4 py-3" placeholder="GitHub - https://github.com/username" id="githubInput">
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <input type="url" class="input-field w-full px-4 py-3" placeholder="LinkedIn - https://linkedin.com/in/username" id="linkedinInput">
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <input type="url" class="input-field w-full px-4 py-3" placeholder="Portfolio - https://myportfolio.com" id="portfolioInput">
                        </div>
                        <button class="btn-send flex items-center justify-center" id="submitLinksBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('submitLinksBtn').addEventListener('click', () => {
                if (this.isProcessing) return;
                this.submitLinks();
            });
        }

        submitLinks() {
            const links = {};
            ['github', 'linkedin', 'portfolio'].forEach(type => {
                const input = document.getElementById(type + 'Input');
                if (input && input.value.trim()) {
                    links[type] = input.value.trim();
                }
            });

            const stepData = {
                response: Object.keys(links).length > 0 ? 'added_links' : 'no_links',
                additionalData: links
            };

            const displayLinks = Object.entries(links).map(([type, url]) => `${type}: ${url}`);
            const message = displayLinks.length > 0 ? `×œ×™× ×§×™×: ${displayLinks.join(', ')}` : '××™×Ÿ ×œ×™× ×§×™× ×›×¨×’×¢';
            this.nextStep(message, stepData);
        }

        async renderSummary() {
            try {
                const profile = this.generateProfileSummary();
                const summaryText = this.formatProfileSummary(profile);

                setTimeout(() => {
                    this.addMessage(summaryText);

                    const inputArea = document.getElementById('inputArea');
                    inputArea.innerHTML = `
                        <div class="flex flex-wrap gap-2 justify-center">
                            <button class="option-button" id="continueBtn">×”×›×œ × ×¨××” ×˜×•×‘, ×‘×•×× ×• × ××©×™×š</button>
                            <button class="option-button" id="editBtn">×¨×•×¦×” ×œ×¢×¨×•×š ××©×”×•</button>
                        </div>
                    `;

                    document.getElementById('continueBtn').addEventListener('click', () => {
                        if (this.isProcessing) return;
                        this.addMessage('×”×›×œ × ×¨××” ×˜×•×‘, ×‘×•×× ×• × ××©×™×š', true);
                        this.nextStep();
                    });

                    document.getElementById('editBtn').addEventListener('click', () => {
                        this.addMessage('×¨×•×¦×” ×œ×¢×¨×•×š ××©×”×•', true);
                        this.addMessage('×‘×©×œ×‘ ×–×” ×–×” ×œ× ×–××™×Ÿ ×¢×“×™×™×Ÿ - × ××©×™×š ×œ×©×œ×‘ ×”×‘×');
                        setTimeout(() => this.nextStep(), 1000);
                    });
                }, 500);

            } catch (error) {
                this.addMessage('×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×™×›×•× ×”×¤×¨×•×¤×™×œ');
            }
        }

        generateProfileSummary() {
            const summary = {};

            Object.entries(this.temporaryData).forEach(([step, data]) => {
                const stepNum = parseInt(step);
                switch (stepNum) {
                    case 3:
                        summary.degree = data.response;
                        break;
                    case 4:
                        summary.year = data.response;
                        break;
                    case 5:
                        summary.field = data.response;
                        break;
                    case 6:
                        summary.institution = data.response;
                        break;
                    case 7:
                        summary.gpa = data.response;
                        break;
                    case 9:
                        summary.experience = data.response;
                        break;
                    case 11:
                        summary.location = data.response;
                        break;
                    case 12:
                        summary.workHours = data.response;
                        break;
                    case 14:
                        summary.personalStatement = data.response;
                        break;
                    case 16:
                        summary.links = data.additionalData;
                        break;
                }
            });

            return summary;
        }

        formatProfileSummary(profile) {
            let summary = "ğŸ“‹ **×¡×™×›×•× ×”×¤×¨×•×¤×™×œ ×©×œ×š:**\n\n";

            if (this.parsedData) {
                summary += `ğŸ‘¤ **×¤×¨×˜×™× ××™×©×™×™×:**\n`;
                summary += `â€¢ ×©×: ${this.parsedData.name || '×œ× ×”×•×–×Ÿ'}\n`;
                summary += `â€¢ ××™××™×™×œ: ${this.parsedData.email || '×œ× ×”×•×–×Ÿ'}\n`;
                summary += `â€¢ ×˜×œ×¤×•×Ÿ: ${this.parsedData.phone || '×œ× ×”×•×–×Ÿ'}\n\n`;
            }

            if (profile.degree || profile.field || profile.institution) {
                summary += `ğŸ“ **×”×©×›×œ×”:**\n`;
                if (profile.degree) summary += `â€¢ ×¡×•×’ ×œ×™××•×“×™×: ${profile.degree}\n`;
                if (profile.year) summary += `â€¢ ×©× ×”: ${profile.year}\n`;
                if (profile.field) summary += `â€¢ ×ª×—×•×: ${profile.field}\n`;
                if (profile.institution) summary += `â€¢ ××•×¡×“: ${profile.institution}\n`;
                if (profile.gpa) summary += `â€¢ ×××•×¦×¢: ${profile.gpa}\n`;
                summary += `\n`;
            }

            if (profile.location || profile.workHours) {
                summary += `ğŸ’¼ **×”×¢×“×¤×•×ª ×¢×‘×•×“×”:**\n`;
                if (profile.location) summary += `â€¢ ××™×§×•×: ${profile.location}\n`;
                if (profile.workHours) summary += `â€¢ ×”×™×§×£ ××©×¨×”: ${profile.workHours}\n`;
                summary += `\n`;
            }

            if (profile.personalStatement) {
                summary += `ğŸ’¬ **××™×©×™:** ${profile.personalStatement.substring(0, 100)}...\n\n`;
            }

            return summary;
        }

        async handleFileUpload(file, uploadType) {
            this.addMessage(`×”×¢×œ×™×ª×™ ×§×•×‘×¥: ${file.name}`, true);
            this.showTyping();
            this.setLoadingState(true);

            try {
                const formData = new FormData();
                formData.append(uploadType, file);

                const endpoint = uploadType === 'cv' ?
                    `${this.apiBase}/chat/${this.sessionId}/upload-cv` :
                    `${this.apiBase}/chat/${this.sessionId}/upload-transcript`;

                console.log('Uploading file to:', endpoint);

                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                this.hideTyping();
                this.setLoadingState(false);

                if (!data.success) {
                    throw new Error(data.error || 'Upload failed');
                }

                if (uploadType === 'cv') {
                    console.log('CV parsed successfully:', data);

                    // Handle existing user scenario
                    if (data.existingUser) {
                        this.existingUserData = data.existingUser;
                        this.addMessage(`× ××¦× ×¤×¨×•×¤×™×œ ×§×™×™× ×¢×‘×•×¨ ${data.existingUser.name}. ×”×× ×‘×¨×¦×•× ×š ×œ×¢×“×›×Ÿ ××•×ª×• ××• ×œ×™×¦×•×¨ ×—×“×©?`);
                        this.renderVerification();
                        return;
                    }

                    // Save parsed data
                    this.parsedData = data.parsedData;
                    console.log('Parsed data saved:', this.parsedData);

                    // Show confidence if available
                    if (data.confidence) {
                        const confStr = Object.entries(data.confidence)
                            .map(([field, conf]) => `${field}: ${Math.round(conf * 100)}%`)
                            .join(', ');
                        console.log('Parsing confidence:', confStr);
                    }

                    this.addMessage('×”×§×•×‘×¥ ×¢×•×‘×“ ×‘×”×¦×œ×—×”! × ×ª×•× ×™× ×©×—×•×œ×¦×• ××”×§×•×‘×¥...');

                    // Move to verification step
                    this.currentStep = 2;
                    this.updateProgress();
                    setTimeout(() => this.renderVerification(), 1000);

                } else if (uploadType === 'transcript') {
                    this.addMessage('×’×œ×™×•×Ÿ ×”×¦×™×•× ×™× × ×©××¨ ×‘×”×¦×œ×—×”!');
                    this.nextStep();
                }

            } catch (error) {
                this.hideTyping();
                this.setLoadingState(false);
                console.error('File upload error:', error);
                this.addMessage('×©×’×™××” ×‘×”×¢×œ××ª ×”×§×•×‘×¥: ' + error.message);

                // Re-render the current step on error
                this.renderCurrentStep();
            }
        }
    }

    // Initialize chat when page loads
    document.addEventListener('DOMContentLoaded', () => {
        new StudentProfileChat();
    });
</script>
</body>
</html>